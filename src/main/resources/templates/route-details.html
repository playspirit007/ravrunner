<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Route Details - RavRunner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --strava-orange: #FC4C02;
            --strava-white: #FFFFFF;
            --strava-dark: #333333;
            --strava-light-gray: #f7f7f7;
            --strava-border: #e0e0e0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--strava-light-gray);
            color: var(--strava-dark);
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(120deg, var(--strava-orange), var(--strava-white));
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo {
            font-weight: 700;
            font-size: 28px;
            color: var(--strava-white);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .logo span {
            color: var(--strava-orange);
        }

        .container-main {
            max-width: 1200px;
            margin: 20px auto;
            background-color: var(--strava-white);
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page-title {
            padding: 20px 30px;
            margin: 0;
            background-color: var(--strava-white);
            border-bottom: 1px solid var(--strava-border);
            font-weight: 600;
            color: var(--strava-dark);
        }

        .content-wrapper {
            padding: 30px;
        }

        #map {
            height: 500px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .route-header {
            background: linear-gradient(135deg, var(--strava-orange) 0%, #ff8c5a 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-card {
            background-color: var(--strava-light-gray);
            border: 1px solid var(--strava-border);
            border-left: 4px solid var(--strava-orange);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
        }

        .waypoint-card {
            background-color: var(--strava-light-gray);
            border: 1px solid var(--strava-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .waypoint-card h6 {
            margin: 0 0 8px 0;
            color: var(--strava-orange);
            font-weight: 600;
        }

        .waypoint-card p {
            margin: 0;
            font-size: 0.85rem;
            color: #666;
        }

        .btn-primary {
            background-color: var(--strava-orange);
            border-color: var(--strava-orange);
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #e04402;
            border-color: #e04402;
        }

        .btn-secondary {
            background-color: var(--strava-dark);
            border-color: var(--strava-dark);
            font-weight: 600;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background-color: var(--strava-white);
            padding: 15px 30px;
            border-top: 1px solid var(--strava-border);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--strava-orange);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons .btn {
            flex: 1;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
            border-radius: 6px;
            padding: 15px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <div class="logo">Rav<span>Runner</span></div>
    </div>
</div>

<div class="container-main">
    <h1 class="page-title">Routen-Details</h1>

    <div class="content-wrapper">
        <!-- Header -->
        <div class="route-header">
            <h1 th:text="${route.name}">Routenname</h1>
            <p class="lead mb-0" th:text="${route.description}">Beschreibung</p>
        </div>

        <!-- Karte -->
        <div class="info-card">
            <h5>üó∫Ô∏è Routenverlauf</h5>
            <div id="mapLoading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Lade Karte...</span>
                </div>
                <p>Berechne Fahrrad-Route √ºber Stra√üen...</p>
            </div>
            <div id="map"></div>
        </div>

        <!-- Statistik-Balken -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="waypointCount" th:text="${route.waypoints != null ? route.waypoints.size() : 0}">0</div>
                <div class="stat-label">Wegpunkte</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalDistance">0 km</div>
                <div class="stat-label">Gesamtstrecke</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalDuration">0 min</div>
                <div class="stat-label">Gesch√§tzte Dauer</div>
            </div>
        </div>

        <!-- Wegpunkte Liste -->
        <div class="info-card">
            <h5>üìç Wegpunkte</h5>
            <div th:if="${route.waypoints == null or route.waypoints.isEmpty()}">
                <div class="alert-warning">
                    ‚ùå Keine Wegpunkte vorhanden.
                </div>
            </div>

            <div th:if="${route.waypoints != null and !route.waypoints.isEmpty()}">
                <div class="row">
                    <th:block th:each="waypoint, iterStat : ${route.waypoints}">
                        <th:block th:if="${waypoint != null}">
                            <div class="col-md-6 mb-3">
                                <div class="waypoint-card">
                                    <h6 class="card-title" th:text="${waypoint.name}">Wegpunkt Name</h6>
                                    <p class="card-text mb-1">
                                        <small class="text-muted">
                                            <strong>üåê Koordinaten:</strong><br>
                                            Breitengrad: <span th:text="${#numbers.formatDecimal(waypoint.latitude, 1, 6)}">0.000000</span><br>
                                            L√§ngengrad: <span th:text="${#numbers.formatDecimal(waypoint.longitude, 1, 6)}">0.000000</span>
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </th:block>
                    </th:block>
                </div>
            </div>
        </div>

        <!-- Aktions-Buttons -->
        <div class="action-buttons">
            <a th:href="@{/routes}" class="btn btn-secondary">‚Üê Zur√ºck zu den Routen</a>
            <a th:href="@{/route/new}" class="btn btn-primary">‚ûï Neue Route erstellen</a>
        </div>
    </div>
</div>

<!-- JavaScript f√ºr die Karte und Routing -->
<script>
    let map;
    let routeLayer;

    // Wegpunkte aus dem HTML extrahieren
    function getWaypointsFromPage() {
        const waypointElements = document.querySelectorAll('.waypoint-card');
        const waypoints = [];

        waypointElements.forEach((element, index) => {
            const titleElement = element.querySelector('h6');
            const latElement = element.querySelector('span:nth-child(3)');
            const lngElement = element.querySelector('span:nth-child(5)');

            if (titleElement && latElement && lngElement) {
                const lat = parseFloat(latElement.textContent.replace(',', '.'));
                const lng = parseFloat(lngElement.textContent.replace(',', '.'));
                const name = titleElement.textContent;

                if (!isNaN(lat) && !isNaN(lng)) {
                    waypoints.push({
                        lat: lat,
                        lng: lng,
                        name: name
                    });
                }
            }
        });

        return waypoints;
    }

    function initMap() {
        const waypoints = getWaypointsFromPage();
        console.log("Gefundene Wegpunkte:", waypoints);

        if (waypoints.length === 0) {
            document.getElementById('mapLoading').innerHTML = '<p>‚ùå Keine g√ºltigen Wegpunkte gefunden</p>';
            return;
        }

        // Karte erstellen
        map = L.map('map').setView([waypoints[0].lat, waypoints[0].lng], 13);

        // OpenStreetMap Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Marker f√ºr alle Wegpunkte
        waypoints.forEach((waypoint, index) => {
            L.marker([waypoint.lat, waypoint.lng])
                .addTo(map)
                .bindPopup(`
                        <div style="text-align: center;">
                            <strong>${waypoint.name}</strong><br>
                            <small>Punkt ${index + 1}</small><br>
                            <small>${waypoint.lat.toFixed(6)}, ${waypoint.lng.toFixed(6)}</small>
                        </div>
                    `);
        });

        // Echte Fahrrad-Route berechnen wenn mindestens 2 Wegpunkte
        if (waypoints.length >= 2) {
            calculateBikeRoute(waypoints);
        } else {
            document.getElementById('mapLoading').style.display = 'none';
            if (waypoints.length === 1) {
                map.setView([waypoints[0].lat, waypoints[0].lng], 15);
                document.getElementById('totalDistance').textContent = '0 km';
                document.getElementById('totalDuration').textContent = '0 min';
            }
        }
    }

    function calculateBikeRoute(waypoints) {
        // Koordinaten f√ºr OSRM API vorbereiten
        const coordinates = waypoints.map(wp => `${wp.lng},${wp.lat}`).join(';');
        const url = `https://router.project-osrm.org/route/v1/bicycle/${coordinates}?overview=full&geometries=geojson`;

        console.log("Berechne echte Fahrrad-Route:", url);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('mapLoading').style.display = 'none';

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    console.log("Route gefunden:", route);
                    drawRealRoute(route);
                    updateRouteInfo(route);
                } else {
                    console.warn("OSRM Route nicht gefunden, zeichne einfache Linie");
                    drawSimpleRoute(waypoints);
                }
            })
            .catch(error => {
                console.error("Fehler bei Routenberechnung:", error);
                document.getElementById('mapLoading').innerHTML =
                    '<p>‚ùå Routenberechnung fehlgeschlagen. Zeichne einfache Route.</p>';
                drawSimpleRoute(waypoints);
            });
    }

    function drawRealRoute(route) {
        // Alte Route entfernen
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        // Echte Fahrrad-Route zeichnen
        routeLayer = L.geoJSON(route.geometry, {
            style: {
                color: '#FC4C02',
                weight: 6,
                opacity: 0.8,
                lineJoin: 'round'
            }
        }).addTo(map);

        // Karte an Route anpassen
        map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
    }

    function drawSimpleRoute(waypoints) {
        // Fallback: Einfache Linie
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }

        routeLayer = L.polyline(
            waypoints.map(wp => [wp.lat, wp.lng]),
            {
                color: '#FC4C02',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }
        ).addTo(map);

        map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
        updateEstimatedInfo(waypoints);
    }

function updateRouteInfo(route) {
    const distance = (route.distance / 1000).toFixed(1); // Meter ‚Üí km

    // ‚öôÔ∏è Eigene Durchschnittsgeschwindigkeit verwenden
    const averageSpeed = 16.5; // km/h
    const durationMinutes = Math.round((distance / averageSpeed) * 60);

    document.getElementById('totalDistance').textContent = distance + ' km';
    document.getElementById('totalDuration').textContent =
        formatDuration(durationMinutes) + ' (√ò16.5 km/h)';
}


    function updateEstimatedInfo(waypoints) {
        let totalDistance = 0;

        // Luftlinie als Sch√§tzung
        for (let i = 0; i < waypoints.length - 1; i++) {
            totalDistance += calculateDistance(
                waypoints[i].lat, waypoints[i].lng,
                waypoints[i + 1].lat, waypoints[i + 1].lng
            );
        }

        // Gesch√§tzte Dauer (18 km/h f√ºr Fahrrad)
        const averageSpeed = 16.5;
        const durationMinutes = Math.round((totalDistance / averageSpeed) * 60);

        document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
        document.getElementById('totalDuration').textContent = formatDuration(durationMinutes);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function formatDuration(minutes) {
        const h = Math.floor(minutes / 60);
        const m = Math.round(minutes % 60);

        if (h > 0) {
            return `${h}h ${m}m`;
        } else {
            return `${m} min`;
        }
    }

    // Karte initialisieren
    document.addEventListener('DOMContentLoaded', initMap);
</script>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</body>
</html>